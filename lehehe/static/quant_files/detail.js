function _defineProperty(t,a,e){return a in t?Object.defineProperty(t,a,{value:e,enumerable:!0,configurable:!0,writable:!0}):t[a]=e,t}function _typeof(t){return(_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}var doneFlag=!1,failFlag=!1,liveMinDate=$("#minLiveDate").val(),accessControl=$("#accessControl").val(),flag=!1,tick,positionOffset,onGetResetDataFlag=!0,isInitFlag=!1,initDataResult=[],initDataBenchmark=[],deepCopy=function t(a){if(a instanceof Array){for(var e=[],i=0;i<a.length;++i)e[i]=t(a[i]);return e}if(a instanceof Object){e={};for(var i in a)e[i]=t(a[i]);return e}return a},prefixInteger=function(t,a){return(Array(a).join(0)+t).slice(-a)},setRangeAllIndex=function(t){chart.rangeSelector.clickButton(t,{type:"all"},!0)},addExcessMaxDrawdownTag=function(t){chart.addSeries({type:"flags",data:[{x:t[0],title:" ",text:"最大回撤"},{x:t[1],title:" ",text:"最大回撤"}],onSeries:"excessSeries",fillColor:"#56d42a",states:{hover:{fillColor:"#56d42a"}},shape:"circlepin",y:-3,height:4,width:4})},calculateMaxDrawdown=function(t){var e,i,n,o,r,s;return t.map(function(t,a){(!e||t.y>e)&&(e=t.y,o=t.x),i=t.y-e,(!n||i<n)&&(n=i,r=t.x,s=[o,r])}),1-n,s},redrawChart=function(){var a,t,i,e,n,o,r=dataResultBak;o="line"===chartType?(n=0,100):(n=100,0),a=r.filter(function(t,a){if(t.x===new Date(chartNavMinDate).getTime())return t}),besicBenchmark=dataBenchmarkBak.filter(function(t,a){if(t.x===new Date(chartNavMinDate).getTime())return t}),isInit?(t=r.map(function(t){return[t.x,t.y+n]}),i=dataBenchmarkBak.map(function(t){return[t.x,t.y+n]}),e=t.map(function(t,a){var e=i[a]||[];return[t[0],(t[1]+o)/(e[1]+o)*100-o]})):a&&(a=a[0],t=r.map(function(t){return[t.x,(t.y-a.y)/(100+a.y)*100+n]}),i=dataBenchmarkBak.map(function(t){return[t.x,(t.y-besicBenchmark[0].y)/(100+besicBenchmark[0].y)*100+n]}),e=t.map(function(t,a){var e=i[a]||[];return[t[0],(t[1]+o)/(e[1]+o)*100-o]})),chart.series[0].setData(t,!1),chart.series[1].setData(i,!1),chart.series[2].setData(e,!1),chart.redraw()},isInit=!0,chartNavMinDate,chartNavMaxDate,onGetResetData=function(t){for(var a=[],e=dataResult,i=0;i<e.length;i++)a.push(e[i].x);chartNavMinDate=getTick(a,t.min),chartNavMaxDate=getTick(a,t.max),isInit=chartNavMinDate===e[0].x,redrawChart()},getTick=function(o,r){var s;return o.push(r),o.sort(),o.find(function(t,a){if(t===r){if(0===a)s=o[1];else if(a===o.length-1)s=o[o.length-1];else{var e=o[a+1],i=new Date(t).getDate(),n=new Date(e).getDate();i===n?s=o[a+2]:i!==n&&(s=e)}return!0}}),s},chart;function getSourceCode($dom){if("0"==$dom.attr("_isLoad"))if(1==accessControl){if(!g_isWinApp||"undefined"==typeof jsObj)return"#请在客户端打开查看源码";var backtestId=$("#backtestId").attr("backtestId_"),res=jsObj.ReadBacktestCode(backtestId),obj=eval("("+res+")");if("00000"!=obj.code)return"#无法查看源码"+obj.msg;$dom.text(obj.data)}else{var id=$dom.attr("_backtestId");Cy.ajax("/algorithm/backtest/source",{async:!1,data:{backtestId:id},success:function(t){"00000"!==t.code?BootstrapDialog.alert(t.msg):($dom.text(t.data.source),$dom.attr("_isLoad","1"))}})}return $dom.text()}function updateResultSize(){var t=$("#backtest-atomic-container").width()-$("#result-area").width()-62;$("body").hasClass("mobile")||$("#splitter-pane").width(t)}function cancel(){Cy.ajax("/algorithm/index/cancel",{data:"backtestId="+backtestId,async:!1,success:function(t){return stopCycle=!0,$("#detail-finished").html("已取消"),$("#backtest-complete").html('<img src="'+g_staticHost+'/std/algorithm/img/backtest_cancel.png"> 已取消'),$("#done-backtest-pane").removeClass("hidden"),$("#inprogress-backtest-pane").addClass("hidden"),$.each($(".enable-when-done"),function(t,a){$(a).css("color","#7d8386"),$(a).css("cursor","pointer")}),!1},fail:function(t){BootstrapDialog.show({title:"提示",btnOKLabel:"确认",message:"无法取消:"+t.msg})}})}$.each($(".enable-when-done"),function(t,a){$(a).css("color","#b3b7bb"),$(a).css("cursor","default")}),$("#view-code-button").click(function(){BootstrapDialog.show({title:"策略代码",btnOKLabel:"确认",cssClass:"code-dialog",message:"",onshown:function(t){var a=$(".bootstrap-dialog-message").eq(0);a.attr("id","code-view");var e=.7*$("body").height();a.css("height",e+"px");var i=getSourceCode($("#code"));a.text(i),$(".code-dialog .modal-dialog").css("width","700px");var n=ace.edit("code-view");n.session.setMode("ace/mode/python"),n.setTheme("ace/theme/tomorrow")},data:{id:"code-dialog"}})}),$("#view-detail-button").click(function(){BootstrapDialog.show({title:"回测详情",btnOKLabel:"确认",message:$("#backtest-detail").html().replace(/(\n)+|(\r\n)+/g,"")})}),$("#export-chart-button").click(function(){chart&&chart.exportChart()}),$("#export-csv-button").click(function(){chart&&(window.location.href="/algorithm/backtest/export?backtestId="+backtestId+"&type=result")}),$(".popover-right").popover({placement:"bottom",trigger:"manual",html:!0,content:'风险指标有利于您对策略进行客观的评价，<a target="_blank" style="color:#337ab7;font-weight:normal" href="/api#%E9%A3%8E%E9%99%A9%E6%8C%87%E6%A0%87">查看计算公式</a>'}).on("mouseenter",function(){var t=this;$(this).popover("show"),$(this).siblings(".popover").on("mouseleave",function(){$(t).popover("hide")})}).on("mouseleave",function(){var t=this;setTimeout(function(){$(".popover:hover").length||$(t).popover("hide")},100)}),updateResultSize(),$(window).resize(function(){updateResultSize()}),$("#result-tabs  a").click(function(){var t;if($(this).hasClass("enable-when-done")&&!doneFlag)return!1;"tab-summaryinfo"===$(".dailybars-output .active").attr("id")?$(".dailybars-output .active").addClass("hidden-1"):$(".dailybars-output .active").addClass("hidden"),"#tab-summaryinfo"===(t=$(this).attr("href").toString())?$(t).removeClass("hidden-1"):($("#tab-summaryinfo").addClass("hidden-1"),$(t).removeClass("hidden")),"#tab-transactioninfo"==t&&0==$(t).attr("_hasDrawn")?fillTransaction():"#tab-positioninfo"==t&&0==$(t).attr("_hasDrawn")?fillPosition():$(this).hasClass("risk")&&0==$(t).attr("_hasDrawn")?fillRisk():"#tab-logs"==t&&0==$(t).attr("_hasDrawn")?fillLog():"#tab-profile"==t&&0==$(t).attr("_hasDrawn")&&fillProfile()}),$("#cancel-backtest-button").click(function(){return BootstrapDialog.confirm({title:"提示",btnCancelLabel:"取消",btnOKLabel:"确认",message:"确实要取消?",callback:function(t){t&&cancel()}}),!1});var resultOffset=0,userRecordOffset=0,logOffset=0,errorLogOffset=0,frequency=$("#frequency").attr("value"),stopCycle=!1,stopResult=!1,backtestId=$("#backtestId").val(),dataResult=[],dataBenchmark=[],excessResult=[],dataGains={earn:[],lose:[]},dataOrders={buy:[],sell:[]},origDataOffset=0,userRecord=null,startDate=$("#startDate").html(),endDate=$("#endDate").html(),minY=0,chartType="line";Highcharts.setOptions({global:{timezoneOffset:-480},lang:{months:["一月","二月","三月","四月","五月","六月","七月","八月","九月","十月","十一月","十二月"],shortMonths:["1月","2月","3月","4月","5月","6月","7月","8月","9月","10月","11月","12月"],weekdays:["星期天","星期一","星期二","星期三","星期四","星期五","星期六"],rangeSelectorZoom:"缩放：",rangeSelectorFrom:"时间：",rangeSelectorTo:"-"}});var timeoutSpan=3e3;function cycleCheck(){stopCycle||(0==stopResult&&drawResult(backtestId),setTimeout(cycleCheck,timeoutSpan))}function fillStatsExtraHtml(t){t.data.win_ratio&&$("#win_ratio").html(t.data.win_ratio.toFixed(3)),t.data.day_win_ratio&&$("#day_win_ratio").html(t.data.day_win_ratio.toFixed(3)),t.data.profit_loss_ratio&&$("#profit_loss_ratio").html(t.data.profit_loss_ratio.toFixed(3)),t.data.win_count&&$("#win_count").html(t.data.win_count),t.data.lose_count&&$("#lose_count").html(t.data.lose_count)}function fillStatsExtra(){$("#backtest-decryptId").val()<175e4||Cy.ajax("/algorithm/backtest/stats?backtestId="+backtestId,{success:function(t){t.data?void 0!==t.data.win_ratio?fillStatsExtraHtml(t):setTimeout(fillStatsExtra,2e3):setTimeout(fillStatsExtra,500)}})}function fillStats(){Cy.ajax("/algorithm/backtest/stats?backtestId="+backtestId,{success:function(t){if(t.data){var a=startDate.substring(0,4),e=startDate.substring(5,7)-1,i=startDate.substring(8,10),n=(new Date(a,e,i,0,0,0).getTime(),""),o="",r="",s="";if(a=endDate.substring(0,4),e=endDate.substring(5,7)-1,i=endDate.substring(8,10),t.data.annual_algo_return)l=t.data.annual_algo_return;else{a=t.data.trading_days/250;var l=Math.pow(1+t.data.algorithm_return,1/a)-1}0<l?o="red":l<0&&(o="green"),0<t.data.algorithm_return?n="red":t.data.algorithm_return<0&&(n="green"),0<t.data.benchmark_return?r="red":t.data.benchmark_return<0&&(r="green"),0<t.data.excess_return?s="red":t.data.excess_return<0&&(s="green"),l&&$("#year_returns").html((100*l).toFixed(2)+"%").addClass(o),t.data.algorithm_return&&$("#total_returns").html((100*t.data.algorithm_return).toFixed(2)+"%").addClass(n),t.data.benchmark_return&&$("#benchmark_returns").html((100*t.data.benchmark_return).toFixed(2)+"%").addClass(r),t.data.excess_return&&$("#excess_return").html((100*t.data.excess_return).toFixed(2)+"%").addClass(s),$("#alpha").html(t.data.alpha.toFixed(3)),$("#beta").html(t.data.beta.toFixed(3)),$("#sharpe").html(t.data.sharpe.toFixed(3)),$("#sortino").html(t.data.sortino.toFixed(3)),$("#information").html(t.data.information.toFixed(3)),$("#algorithm_volatility").html(t.data.algorithm_volatility.toFixed(3)),$("#benchmark_volatility").html(t.data.benchmark_volatility.toFixed(3)),$("#excess_return_max_drawdown").html(null===t.data.excess_return_max_drawdown?"--":t.data.excess_return_max_drawdown),$("#avg_excess_return").html(null===t.data.avg_excess_return?"--":t.data.avg_excess_return),$("#excess_return_sharpe").html(null===t.data.excess_return_sharpe?"--":t.data.excess_return_sharpe),void 0===t.data.win_ratio?fillStatsExtra():fillStatsExtraHtml(t);var c=(100*t.data.max_drawdown).toFixed(2)+"%",d=t.data.max_drawdown_period;if(d){var u=(d=d.map(function(t,a){return 0<=t.indexOf("-")&&(t=t.split("-").join("/")),t}))[0]+","+d[1];chart.addSeries({type:"flags",data:[{x:Date.parse(new Date(d[0]+" 16:00:00")),title:" ",text:"最大回撤"},{x:Date.parse(new Date(d[1]+" 16:00:00")),title:" ",text:"最大回撤"}],onSeries:"returnSeries",fillColor:"#00BB00",states:{hover:{fillColor:"#00BB00"}},shape:"circlepin",y:-3,height:4,width:4})}$("#max_drawdown").html(c),$("#max_drawdown_period").html(u),t.data.report_done_seconds&&$("#run-time-cost").html(" , 耗时"+t.data.report_done_seconds.toFixed(2)+"s")}else setTimeout(fillStats,500)}})}var isBacktestLogMax=!1;function fillLog(l){null==_typeof(l)&&(l=0),Cy.ajax("/algorithm/backtest/log?backtestId="+backtestId+"&offset="+logOffset,{fail:function(t){},success:function(t){if((isBacktestLogMax=t.data.max)&&handleAddExportZip(backtestId,"log",handleAddExportZipSuccess),(0!=t.data.logArr.length||2!=t.data.state&&3!=t.data.state)&&!(t.data.offset<logOffset)){0==logOffset&&($("#logs-init").addClass("hidden"),$("#log").scroll(function(){if(nScrollHight=$(this)[0].scrollHeight,(l=$(this)[0].scrollTop)+550>=nScrollHight){if(isBacktestLogMax)return void handleAddExportZip(backtestId,"log",handleAddExportZipSuccess);fillLog(l)}}));for(var a="",e=0;e<t.data.logArr.length;e++)if(t.data.logArr[e]){var i=t.data.logArr[e].split(" - ");if(2<i.length){var n='<span class="log-date">'+i[0]+"</span> - ";if("ERROR"==i[1])var o="log-error";else if("WARNING"==i[1])o="log-warning";else o="log-info";var r='<span class="'+o+'">'+i[1]+"</span> - ";i.shift(),i.shift();var s=n+r+i.join("-")}else s=t.data.logArr[e];a=a+"<p>"+s.replace(/\n/g,"<br/>"),logOffset++}$("#log").find("pre").eq(0).append(a),$("#id").scrollTop(l)}}})}function fillErrorLog(t){Cy.ajax("/algorithm/backtest/error?backtestId="+t,{success:function(t){for(var a="",e=0;e<t.data.logArr.length;e++)a=a+"<p>"+t.data.logArr[e].replace(/\n/g,"<br/>"),errorLogOffset++;$("#log").find("pre").eq(0).prepend(a)}})}function fillProfile(){Cy.ajax("/algorithm/backtest/profile?backtestId="+backtestId,{success:function(t){if(t.data.profile&&0<t.data.profile.length)$("#profile").find("pre").eq(0).append(t.data.profile);else{$("#profile").find("pre").eq(0).append("暂无相关内容，请确认在代码最开始使用enable_profile()打开性能分析。请在API中查看enable_profile()使用方法")}$("#tab-profile").attr("_hasDrawn",1)}})}function fail(){failFlag=!0,$("#done-backtest-pane").removeClass("hidden"),$("#backtest-complete").html('<img src="'+g_staticHost+'/std/algorithm/img/backtest_cancel.png"> 回测失败'),$("#inprogress-backtest-pane").addClass("hidden"),fillErrorLog(backtestId),enableShare(),doneFlag=!0,$.each($(".enable-when-done"),function(t,a){$(a).css("color","#7d8386"),$(a).css("cursor","pointer")})}var dataResultLog=[],dataBenchmarkLog=[],excessResultLog=[],dataResultBak=[],dataBenchmarkBak=[],excessResultBak=[];function changeToLogarithm(){if("log"===chartType)return!1;onGetResetDataFlag=!0,offset=100,chartType="log";for(var t=0;t<dataResult.length;t++)dataResultLog[t]={},dataResultLog[t].x=dataResult[t].x,dataResultLog[t].y=dataResult[t].y+offset,dataBenchmarkLog[t]={},dataBenchmarkLog[t].x=dataBenchmark[t].x,dataBenchmarkLog[t].y=dataBenchmark[t].y+offset,excessResultLog[t]={},excessResultLog[t].x=excessResult[t].x,excessResultLog[t].y=dataResultLog[t].y/dataBenchmarkLog[t].y*100;chart.yAxis[0].update({type:"logarithmic",labels:{formatter:function(){return(this.value-offset).toFixed(2)+"%"}}},!1);for(t=0;t<3;t++)chart.series[t].update({threshold:offset,tooltip:{pointFormatter:function(){return pointFormat='<span style="color:{point.color}">●</span> {series.name}: <b>'+(this.y-offset).toFixed(2)+"%</b><br/>",Highcharts.format(pointFormat,{point:this,series:this.series})}}},!1);isInit?draw(dataResultLog,dataBenchmarkLog,excessResultLog,userRecord,dataGains,dataOrders):redrawChart()}function changeToLine(){if("line"===chartType)return!1;chartType="line",onGetResetDataFlag=!0,chart.yAxis[0].update({type:"line",labels:{formatter:function(){return this.value.toFixed(2)+"%"}}},!1);for(var t=0;t<3;t++)chart.series[t].update({threshold:0,tooltip:{pointFormatter:function(){return pointFormat='<span style="color:{point.color}">●</span> {series.name}: <b>'+this.y.toFixed(2)+"%</b><br/>",Highcharts.format(pointFormat,{point:this,series:this.series})}}},!1);isInit?draw(dataResultBak,dataBenchmarkBak,excessResultBak,userRecord,dataGains,dataOrders):redrawChart()}function drawResult(t){stopResult=!0,Cy.ajax("/algorithm/backtest/result?backtestId="+t+"&offset="+resultOffset+"&userRecordOffset="+userRecordOffset,{timeout:5e3,fail:function(t){stopResult=!1},error:function(t){stopResult=!1},success:function(t){if(0!=t.data.state){var a=t.data.result.benchmark,e=t.data.result.overallReturn,i=t.data.result.gains,n=t.data.result.orders,o=t.data.result.count,r=parseInt(t.data.result.offset);if(!(o<=0&&2!=t.data.state&&(3==t.data.state?fail():stopResult=!1,0===t.data.state))){if(chart||(chart=newChart(t.data.userRecord),clearHighchartLable()),t.data.userRecord){if(!userRecord)for(var s in userRecord={},t.data.userRecord)userRecord[s]=getRemainNullData();for(var s in t.data.userRecord)void 0===userRecord[s]&&(userRecord[s]=getRemainNullData(),chart.addSeries({name:s,data:userRecord[s],dataGrouping:grouping_options,yAxis:1},!1))}for(var l={},c=null,d=0;d<o;d++)dataResult[d+r]&&(dataResult[d+r].x=e.time[d],dataResult[d+r].y=e.value[d],excessResult[d+r].x=e.time[d],excessResult[d+r].y=(e.value[d]+100)/(a.value[d]+100)*100-100,dataBenchmark[d+r].x=a.time[d],dataBenchmark[d+r].y=a.value[d],c=dataResult[d+r].y<excessResult[d+r].y?dataResult[d+r].y:excessResult[d+r].y,dataBenchmark[d+r].y<c&&(c=dataBenchmark[d+r].y),c<minY&&(minY=c),dataGains.earn[d+r].x=i.earn.time[d],dataGains.earn[d+r].y=i.earn.value[d],dataGains.lose[d+r].x=i.lose.time[d],dataGains.lose[d+r].y=i.lose.value[d],dataOrders.buy[d+r].x=n.buy.time[d],dataOrders.buy[d+r].y=n.buy.value[d],dataOrders.sell[d+r].x=n.sell.time[d],dataOrders.sell[d+r].y=n.sell.value[d],l[e.time[d]]=d+r);if(t.data.userRecord){var u=1e5;for(var s in t.data.userRecord){var h=0;for(d=0;d<t.data.userRecord[s].time.length;d++)if(t.data.userRecord[s].time[d]){var f=86400*parseInt(t.data.userRecord[s].time[d]/1e3/86400)*1e3-288e5,p=timeBar[f];userRecord[s][p]||(userRecord[s][p]={}),userRecord[s][p].x=t.data.userRecord[s].time[d],userRecord[s][p].y=t.data.userRecord[s].value[d],h++}u=Math.min(u,h)}userRecordOffset+=u}if(resultOffset=r+o,0<dataResult.length&&0<resultOffset&&dataResult.length>=resultOffset){var g=dataResult[resultOffset-1].x;for(d=resultOffset;d<dataResult.length&&dataResult[d].x<g;d++)dataResult[d].x=g,excessResult[d].x=g,dataBenchmark[d].x=g,dataGains.earn[d].x=g,dataGains.lose[d].x=g,dataOrders.buy[d].x=g,dataOrders.sell[d].x=g}for(d=0;d<dataResult.length;d++)dataResultBak[d]={},dataResultBak[d].x=dataResult[d].x,dataResultBak[d].y=dataResult[d].y,dataBenchmarkBak[d]={},dataBenchmarkBak[d].x=dataBenchmark[d].x,dataBenchmarkBak[d].y=dataBenchmark[d].y,excessResultBak[d]={},excessResultBak[d].x=excessResult[d].x,excessResultBak[d].y=excessResult[d].y;if(draw(dataResult,dataBenchmark,excessResult,userRecord,dataGains,dataOrders),3==t.data.state)return fail(),void(o<=0&&(stopResult=doneFlag=!0));if(4==t.data.state)return failFlag=!0,$("#done-backtest-pane").removeClass("hidden"),$("#backtest-complete").html('<img src="'+g_staticHost+'/std/algorithm/img/backtest_cancel.png"> 已取消'),$("#inprogress-backtest-pane").addClass("hidden"),$.each($(".enable-when-done"),function(t,a){$(a).css("color","#7d8386"),$(a).css("cursor","pointer")}),void(doneFlag=stopResult=!0);if((2==t.data.state||3==t.data.state)&&0==o)return stopCycle=!0,$("#detail-finished").html("完成"),setRangeAllIndex(2),$("#done-backtest-pane").removeClass("hidden"),$("#inprogress-backtest-pane").addClass("hidden"),$("#btn-attributionAnaly").removeClass("disabled"),fillStats(),stopResult=doneFlag=!0,$.each($(".enable-when-done"),function(t,a){$(a).css("color","#7d8386"),$(a).css("cursor","pointer")}),enableLiveTrade(),enableShare(),isTanChuang(),$(".chart-type").removeAttr("disabled"),initDataResult=deepCopy(dataResult),void(initDataBenchmark=deepCopy(dataBenchmark));var m=Math.min(100,resultOffset/dataResult.length*100).toFixed(1);80<m&&(timeoutSpan=1e3),$("#backtest-progress-bar").width(m+"%"),$("#backtest-progress-label").html(m+"%"),stopResult=!1}}else stopResult=!1}})}$(".chart-type").click(function(){"log"===$(this).val()?changeToLogarithm():changeToLine()}),$("#exceedReturn").click(function(){var t,a,e=$(this).is(":checked");flag||(addExcessMaxDrawdownTag(calculateMaxDrawdown(excessResult)),flag=!0),t=chart.series[chart.series.length-1],a=chart.series[2],e?(a.show(),t.show()):(a.hide(),t.hide())}),Date.prototype.Format=function(t){var a={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};for(var e in/(y+)/.test(t)&&(t=t.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length))),a)new RegExp("("+e+")").test(t)&&(t=t.replace(RegExp.$1,1==RegExp.$1.length?a[e]:("00"+a[e]).substr((""+a[e]).length)));return t};var g_tradeDays=null,timeBar={};function getRemainNullData(){for(var t=[],a=0;a<g_tradeDays.length;a++)tick=1e3*g_tradeDays[a],t.push({x:tick,y:null}),timeBar[tick]=a;return t}function initChartData(){dataResult=getRemainNullData(),excessResult=getRemainNullData(),dataBenchmark=getRemainNullData(),dataOrders.buy=getRemainNullData(),dataOrders.sell=getRemainNullData(),dataGains.earn=getRemainNullData(),dataGains.lose=getRemainNullData(),errorLogOffset=logOffset=userRecordOffset=resultOffset=origDataOffset=0,chart&&(chart.destroy(),chart=userRecord=null)}function initChart(a){Cy.ajax("/algorithm/backtest/tradeDays?startDay="+startDate+"&endDay="+endDate,{success:function(t){t.data&&(g_tradeDays=t.data),initChartData(),a()},fail:function(t){initChartData(),a()}})}function draw(t,a,e,i,n,o){var r=3;if(chart.series[0].setData(t,!1),chart.series[1].setData(a,!1),chart.series[2].setData([].concat(e),!1),i)for(var s in i)chart.series[r]&&chart.series[r].setData(i[s],!1),r++;chart.series[r++].setData(n.earn,!1),chart.series[r++].setData(n.lose,!1),chart.series[r++].setData(o.buy,!1),chart.series[r].setData(o.sell,!1),chart.redraw()}function clearHighchartLable(){$("text[text-anchor=end]").each(function(){"Highcharts.com"==this.innerHTML&&$(this).remove()})}var hasDrawLeftLine=!1;function drawLeftLine(){hasDrawLeftLine||($("path[stroke=lightgray]").each(function(t){var a=$(this).attr("d").split(" ");if(parseFloat(a[1])<100){for(var e=1;e<a.length;e+=3)a[e]=10;posNew=a.join(" ");var i=$(this).clone();$(i).attr("d",posNew),$(this.parentNode).append(i)}}),hasDrawLeftLine=!0)}var grouping_options=null;function newChart(t){var a=[{type:"area",name:"策略收益",color:"#4572A7",tooltip:{dateTimeLabelFormats:{day:"%Y-%m-%d,%A"},valueDecimals:2,valueSuffix:"%"},fillOpacity:.2,id:"returnSeries",data:[]},{name:"基准收益",color:"#aa4643",tooltip:{dateTimeLabelFormats:{day:"%Y-%m-%d,%A"},valueDecimals:2,valueSuffix:"%"},data:[]},{name:"超额收益",visible:!(grouping_options={enabled:!0,approximation:"average",units:[["week",[1]],["month",[1,2,3,4,6]]],groupPixelWidth:1}),id:"excessSeries",color:"#FFA042",tooltip:{dateTimeLabelFormats:{day:"%Y-%m-%d,%A"},valueDecimals:2,valueSuffix:"%"},data:[]}],e=null,i=null;if(t){var n,o=1;for(var r in e=16,i=60,t)a.push({name:r,data:[],dataGrouping:grouping_options,yAxis:1});var s=[(n={height:"36%",lineWidth:2,title:{text:"收益"},tickPixelInterval:20,minorGridLineWidth:1,minorTickWidth:0,opposite:!0},_defineProperty(n,"lineWidth",1),_defineProperty(n,"plotLines",[{value:0,color:"black",width:2}]),_defineProperty(n,"labels",{align:"right",x:-3,formatter:function(){return this.value+"%"}}),n),_defineProperty({labels:{align:"right",x:-3},title:{text:"自定义数据"},tickPixelInterval:20,minorGridLineWidth:1,minorTickWidth:0,opposite:!0,lineWidth:1,plotLines:[{value:0,color:"black",width:2}],top:"40%",height:"20%",offset:0},"lineWidth",2)]}else{var l;o=0;e=26,i=40;s=[(l={height:"36%",lineWidth:2,title:{text:"收益"},tickPixelInterval:20,minorGridLineWidth:1,minorTickWidth:0,opposite:!0},_defineProperty(l,"lineWidth",1),_defineProperty(l,"plotLines",[{value:0,color:"black",width:2}]),_defineProperty(l,"labels",{align:"right",x:-3,formatter:function(){return this.value+"%"}}),l)]}return s.push({title:{text:"每日盈亏"},plotLines:[{value:0,color:"black",width:2}],top:i+4+"%",height:e+"%",offset:0,lineWidth:2}),s.push({title:{text:"每日买卖"},plotLines:[{value:0,color:"black",width:2}],top:i+e+8+"%",height:e+"%",offset:0,lineWidth:2}),a.push({type:"column",name:"当日盈利",data:[],dataGrouping:grouping_options,yAxis:o+1}),a.push({type:"column",name:"当日亏损",data:[],dataGrouping:grouping_options,tooltip:{dateTimeLabelFormats:{day:"%Y-%m-%d,%A"},pointFormatter:function(t){return t='<span style="color:{point.color}">●</span> {series.name}: <b>'+Math.abs(this.y)+"</b><br/>",Highcharts.format(t,{point:this,series:this.series})}},yAxis:o+1}),a.push({type:"column",name:"当日开仓",data:[],dataGrouping:grouping_options,yAxis:o+2}),a.push({type:"column",name:"当日平仓",data:[],dataGrouping:grouping_options,tooltip:{dateTimeLabelFormats:{day:"%Y-%m-%d,%A"},pointFormatter:function(t){return t='<span style="color:{point.color}">●</span> {series.name}: <b>'+Math.abs(this.y)+"</b><br/>",Highcharts.format(t,{point:this,series:this.series})}},yAxis:o+2}),chart=new Highcharts.StockChart({chart:{renderTo:"backtest-chart-outer-container",events:{tooltipRefresh:function(t){chartHoverPointIndex=chart.hoverPoints[0].index}},animation:Highcharts.svg,marginRight:22},credits:{enabled:!1},exporting:{enabled:!1},scrollbar:{enabled:!1},colors:["#89A54E","#80699B","#18a5ca","#DB843D","#A47D7C"],title:{text:""},rangeSelector:{buttons:[{type:"month",count:1,text:"1个月"},{type:"month",count:12,text:"1年"},{type:"all",text:"全部"}],inputEnabled:!0,inputDateFormat:"%Y-%m-%d",inputPosition:{x:-10},selected:2},plotOptions:{series:{turboThreshold:0,connectNulls:!0,marker:{states:{hover:{enabled:!0,radius:4}},symbol:"circle"},animation:!1}},legend:{enabled:!1,align:"center",verticalAlign:"top",y:55,borderWidth:0},navigator:{series:{color:"transparent",lineWidth:0},height:20,maskFill:"rgba(180, 198, 220, 0.75)",xAxis:{type:"datetime",labels:{formatter:function(){return Highcharts.dateFormat("%y-%m-%d",this.value)}}}},xAxis:{gridLineWidth:1,gridLineColor:"lightgray",categories:[],type:"datetime",tickPixelInterval:120,labels:{style:{fontSize:"10px"},formatter:function(){return Highcharts.dateFormat("%y-%m-%d",this.value)}},allowDecimals:!1,events:{setExtremes:function(t){isInitFlag||"rangeSelectorButton"!==t.trigger?onGetResetDataFlag&&("rangeSelectorButton"==t.trigger||"navigator"===t.trigger&&("mouseup"===t.DOMEvent.type||"touchend"===t.DOMEvent.type)?onGetResetData(t):"rangeSelectorInput"===t.trigger&&onGetResetData(t)):isInitFlag=!0}}},yAxis:s,series:a})}var chartHoverPointIndex=0;document.onkeydown=function(t){var a,e=chart;switch(e&&(a=e.series[0].points.length),t.keyCode){case 37:0==chartHoverPointIndex?chartHoverPointIndex=chartHoverPointIndex:chartHoverPointIndex-=1;for(var i=[],n=0;n<e.series.length;n++)i[n]=e.series[n].points[chartHoverPointIndex];e.tooltip.refresh(i);break;case 39:chartHoverPointIndex==a?chartHoverPointIndex=chartHoverPointIndex:chartHoverPointIndex+=1;for(i=[],n=0;n<e.series.length;n++)i[n]=e.series[n].points[chartHoverPointIndex];e.tooltip.refresh(i)}};var transactionTdWidth=null,transactionDisplayCols=["amount","transaction","type","price","total","gains","commission"];function drawTransactioninfo(t){var a=["日期","委托时间","品种","标的","交易类型","下单类型","成交数量","成交价","成交额","委托数量","委托价格","状态","平仓盈亏","手续费","最后更新时间"],e=[{name:"date",index:"date",align:"center",sorttype:"date",formatter:"date"},{name:"time",index:"time",align:"center"},{name:"security",index:"security",align:"center"},{name:"stock",index:"stock",align:"center",width:300},{name:"transaction",index:"transaction",align:"center",sorttype:!1},{name:"type",index:"type",align:"center",sorttype:!1},{name:"amount",index:"amount",align:"center",sorttype:"float"},{name:"price",index:"price",align:"center",sorttype:"float"},{name:"total",index:"total",align:"center",sorttype:"float",formatter:"number",width:180},{name:"orderAmount",index:"orderAmount",align:"center",sorttype:"float"},{name:"limitPrice",index:"limitPrice",align:"center",sorttype:"float"},{name:"status",index:"status",align:"center",sorttype:"float"},{name:"gains",index:"gains",align:"center",sorttype:"float",formatter:"number"},{name:"commission",index:"commission",align:"center",sorttype:"float",formatter:"number"},{name:"matchTime",index:"matchTime",align:"center",sorttype:"date",formatter:"date",formatoptions:{srcformat:"Y-m-d H:i:s",newformat:"Y-m-d H:i:s"}}],i={date:1,time:1,stock:1},n={type:1,gains:1,orderAmount:1,limitPrice:1,commission:1},o=$.cookie("default_transaction_cols");o&&0<o.length&&(transactionDisplayCols=o.split(","));for(var r={},s=0;s<transactionDisplayCols.length;s++)r[transactionDisplayCols[s]]=1;for(s=0;s<e.length;s++)r[e[s].index]||i[e[s].index]||(e[s].hidden=!0);var l={autowidth:!0,shrinkToFit:!0,data:t,datatype:"local",height:570,rowNum:1e4,colNames:a,colModel:e,viewrecords:!0,hidegrid:!1,altRows:!0,grouping:!0,groupingView:{groupField:["date","time"],groupSummary:[!0,!1],groupColumnShow:[!0,!0],groupText:[!1,!1],groupCollapse:!1,groupOrder:["asc","asc"]},caption:null};6<transactionDisplayCols.length&&(l.shrinkToFit=!1,l.autoScroll=!0);$("#table-transactioninfo").jqGrid(l);transactionTdWidth=$("#table-transactioninfo").getGridParam("width");var c,d="",u=$(".title_item.actives").attr("role");for(s=0;s<a.length;s++)i[e[s].index]||"conclude_trans"==u&&n[e[s].index]||(d=d+' <div class="checkbox"><label><span class="check_label '+(c=r[e[s].index]?"checked":"")+'"><input type="checkbox" name="transaction-select" value="'+e[s].index+'" '+c+"></span>"+a[s]+"</label></div>");return $("#transaction-column-select").html(d),$("#table-transactioninfo")}$("#transaction-column-select").delegate("input","click",function(){var t=$(this).val();if(this.checked){$("#table-transactioninfo").jqGrid("showCol",t),transactionDisplayCols.push(t);var a=transactionDisplayCols.join(",");$.cookie("default_transaction_cols",a),$(this).parent().addClass("checked");for(var e=$("#table-transactioninfo").jqGrid("getGridParam","colModel"),i=0,n=0;n<e.length;n++)!1===e[n].hidden&&i++;6<i&&$("#table-transactioninfo").jqGrid("setGridParam",{shrinkToFit:!1,autoScroll:!0})}else{$("#table-transactioninfo").jqGrid("hideCol",t);for(var o=null,r=0;r<transactionDisplayCols.length;r++)if(transactionDisplayCols[r]==t){o=r;break}o&&transactionDisplayCols.splice(o,1);a=transactionDisplayCols.join(",");$.cookie("default_transaction_cols",a),$(this).parent().removeClass("checked");for(e=$("#table-transactioninfo").jqGrid("getGridParam","colModel"),i=0,n=0;n<e.length;n++)!1===e[n].hidden&&i++;i<=6&&$("#table-transactioninfo").jqGrid("setGridParam",{shrinkToFit:!0,autoScroll:!1})}$("#table-transactioninfo").setGridWidth(transactionTdWidth)});var positionTdWidth=null,positionDisplayCols=["amount","price","position","gain","value"];function drawPositioninfo(t){var a=["日期","品种","标的","多空","数量","可用数量","收盘价/结算价","市值/价值","盈亏/逐笔浮盈","开仓均价","持仓均价(期货)","保证金","当日盈亏","今手数","仓位占比","盈亏占比"],e=[{name:"date",index:"date",align:"center",sorttype:"date",formatter:"date",resizable:!1},{name:"security",index:"security",align:"center",resizable:!1},{name:"stock",index:"stock",align:"center",sorttype:function(t,a){return'<span class="label label-cash">Cash</span>'==t?"*"+t:t},resizable:!1},{name:"side",index:"side",align:"center",resizable:!1},{name:"amount",index:"amount",align:"center",sorttype:"float",resizable:!1},{name:"closeableAmount",index:"closeableAmount",align:"center",sorttype:"float"},{name:"price",index:"price",align:"center",sorttype:"float",resizable:!1},{name:"value",index:"value",align:"center",sorttype:"int",formatter:"number",width:180,summaryType:"sum",summaryTpl:"<b>总共:{0}</b>",resizable:!1},{name:"gain",index:"gain",align:"center",sorttype:"float",formatter:"number",summaryType:"sum",resizable:!1},{name:"avgCost",index:"avgCost",align:"center",sorttype:"float",resizable:!1},{name:"holdCost",index:"holdCost",align:"center",sorttype:"float",resizable:!1},{name:"margin",index:"margin",align:"center",sorttype:"float",formatter:"number",summaryType:"sum",resizable:!1},{name:"dailyGains",index:"dailyGains",align:"center",sorttype:"float",formatter:"number",summaryType:"sum",resizable:!1},{name:"todayAmount",index:"todayAmount",align:"center",sorttype:"float",resizable:!1},{name:"positionPersent",index:"positionPersent",align:"center",sorttype:"float",resizable:!1,formatter:function(t,a,e){return t=t?parseFloat(t.split("%")[0]).toFixed(2)+"%":""}},{name:"gainPercentStr",index:"gainPercentStr",align:"center",sorttype:"float",resizable:!1}],i={date:1,time:1,stock:1},n=$.cookie("default_position_cols");n&&0<n.length&&(positionDisplayCols=n.split(","));for(var o={},r=0;r<positionDisplayCols.length;r++)o[positionDisplayCols[r]]=1;for(r=0;r<e.length;r++)o[e[r].index]||i[e[r].index]||(e[r].hidden=!0);var s={autowidth:!0,shrinkToFit:!0,data:t,datatype:"local",height:570,rowNum:1e4,colNames:a,colModel:e,viewrecords:!0,hidegrid:!1,altRows:!0,grouping:!0,groupingView:{groupField:["date"],groupSummary:[!0],groupColumnShow:[!1],groupText:["<b>{0}</b>"],groupCollapse:!1,groupOrder:["asc"]},caption:null};7<positionDisplayCols.length&&(s.shrinkToFit=!1,s.autoScroll=!0),$("#table-positioninfo").jqGrid(s),positionTdWidth=$("#table-positioninfo").getGridParam("width");var l="",c="";for(r=0;r<a.length;r++)i[e[r].index]||(l=l+' <div class="checkbox"><label><span class="check_label '+(c=o[e[r].index]?"checked":"")+'"><input type="checkbox" name="position-select" value="'+e[r].index+'" '+c+"></span>"+a[r]+"</label></div>");return $("#position-column-select").html(l),$("#table-positioninfo")}function drawRisk(t,a,e){if(!(a.length<=0)){var i=[{name:"date",index:"date",width:196,align:"center"}];for(var n in a[0])"date"!=n&&i.push({name:n,index:n,width:175,align:"center",formatter:"currency",formatoptions:{decimalPlaces:4},sorttype:"float"});$("#"+t).jqGrid({data:a,datatype:"local",height:570,rowNum:1e4,colNames:e,colModel:i,viewrecords:!0,hidegrid:!1,altRows:!0})}}function drawBenchmarkPeriodReturn(t){drawRisk("table-benchmark_period_return",t,["日期","1个月","3个月","6个月","12个月"])}function drawAlgorithmPeriodReturn(t){drawRisk("table-algorithm_period_return",t,["日期","1个月","3个月","6个月","12个月"])}function drawAlpha(t){drawRisk("table-alpha",t,["日期","1个月","3个月","6个月","12个月"])}function drawBeta(t){drawRisk("table-beta",t,["日期","1个月","3个月","6个月","12个月"])}function drawSharp(t){drawRisk("table-sharpe",t,["日期","1个月","3个月","6个月","12个月"])}function drawSortino(t){drawRisk("table-sortino",t,["日期","1个月","3个月","6个月","12个月"])}function drawInformation(t){drawRisk("table-information",t,["日期","1个月","3个月","6个月","12个月"])}function drawAlgovolatility(t){drawRisk("table-algo_volatility",t,["日期","1个月","3个月","6个月","12个月"])}function drawBenchmarkvolatility(t){drawRisk("table-benchmark_volatility",t,["日期","1个月","3个月","6个月","12个月"])}function drawMaxdrawdown(t){drawRisk("table-max_drawdown",t,["日期","1个月","3个月","6个月","12个月"])}function initTransaction(){addTransaction(),$("#table-transactioninfo").height()<$(".transaction-info-pane").eq(0).height()&&setTimeout(initTransaction,5e3)}$("#position-column-select").delegate("input","click",function(){var t=$(this).val();if(this.checked){$("#table-positioninfo").jqGrid("showCol",t),positionDisplayCols.push(t);var a=positionDisplayCols.join(",");$.cookie("default_position_cols",a),$(this).parent().addClass("checked");for(var e=$("#table-positioninfo").jqGrid("getGridParam","colModel"),i=0,n=0;n<e.length;n++)!1===e[n].hidden&&i++;7<i&&$("#table-positioninfo").jqGrid("setGridParam",{shrinkToFit:!1,autoScroll:!0})}else{$("#table-positioninfo").jqGrid("hideCol",t);for(var o=null,r=0;r<positionDisplayCols.length;r++)if(positionDisplayCols[r]==t){o=r;break}o&&positionDisplayCols.splice(o,1);a=positionDisplayCols.join(",");$.cookie("default_position_cols",a),$(this).parent().removeClass("checked");for(e=$("#table-positioninfo").jqGrid("getGridParam","colModel"),i=0,n=0;n<e.length;n++)!1===e[n].hidden&&i++;i<=7&&$("#table-positioninfo").jqGrid("setGridParam",{shrinkToFit:!0,autoScroll:!1})}$("#table-positioninfo").setGridWidth(positionTdWidth)});var transactionDateOffset=startDate;function fillTransaction(){$("#tab-transactioninfo").attr("_hasDrawn",1),Cy.ajax("/algorithm/backtest/transactionInfo?backtestId="+backtestId,{success:function(t){if("0"!==t.data.status){$("#transaction-loading").remove();for(var a=new Array,e=0;e<t.data.transaction.length;e++){var i=t.data.transaction[e];"string"==typeof i.total&&-1<i.total.indexOf("(")&&(i.total=i.total.match(/\((.+)\)/)[1]),a.push(i),transactionDateOffset=i.tradeDate?i.tradeDate:i.date}var n=drawTransactioninfo(a);if(transactionOffset=t.data.transaction.length,bindGroupEvent(n),t.data.max){var o='<div class="backtest-detail__bottom-export">                    页面仅展示前1000条记录，查看全部请                    <span class="logdaochu"                        type="transaction"                        backtestId="'+backtestId+'"                    >导出交易详情</span>                </div>';$("#table-transactioninfo").after(o)}else $("#tab-transactioninfo").find(".ui-jqgrid-bdiv").scroll(function(){nScrollHight=$(this)[0].scrollHeight,nScrollTop=$(this)[0].scrollTop,nScrollTop+570>=nScrollHight&&addTransaction(nScrollTop)}),1==t.data.status&&initTransaction()}else setTimeout(fillTransaction,3e3)},fail:function(){$("#tab-transactioninfo").attr("_hasDrawn",0)}})}var transactionLoading=0;function addTransaction(n){if(1!=transactionLoading){transactionLoading=1;var o=$("#table-transactioninfo");Cy.ajax("/algorithm/backtest/transactionInfo?backtestId="+backtestId+"&offset="+transactionOffset+"&dateOffset="+transactionDateOffset,{success:function(t){if(t.data.transaction.length<=0)1==t.data.status&&(transactionLoading=0);else{for(var a=0;a<t.data.transaction.length;a++){var e=t.data.transaction[a];0!=e.amount&&("string"==typeof e.total&&-1<e.total.indexOf("(")&&(e.total=e.total.match(/\((.+)\)/)[1]),o.jqGrid("addRowData",a,e,"last")),transactionDateOffset=e.tradeDate?e.tradeDate:e.date}if(o.jqGrid("sortGrid","date",!0),bindGroupEvent(o),n&&$("#tab-transactioninfo").find(".ui-jqgrid-bdiv").scrollTop(n),t.data.max){var i='<div class="backtest-detail__bottom-export">                        页面仅展示前1000条记录，查看全部请                        <span class="logdaochu"                            type="transaction"                            backtestId="'+backtestId+'"                        >导出交易详情</span>                    </div>';$("#table-transactioninfo").after(i)}else transactionOffset+=t.data.transaction.length,transactionLoading=0}}})}}function initPosition(){addPosition(),$("#table-positioninfo").height()<$(".transaction-info-pane").eq(1).height()&&setTimeout(initPosition,5e3)}var positionDateOffset=startDate;function fillPosition(){$("#tab-positioninfo").attr("_hasDrawn",1),Cy.ajax("/algorithm/backtest/positionInfo?backtestId="+backtestId,{success:function(t){if("0"!==t.data.status){$("#position-loading").remove();for(var a=new Array,e=0;e<t.data.position.length;e++)a.push(t.data.position[e]),positionDateOffset=t.data.position[e].date;var i=drawPositioninfo(a);if(positionOffset=t.data.position.length,i.sortGrid("stock",!0,"desc"),bindGroupEvent(i),t.data.max){var n='<div class="backtest-detail__bottom-export">                    页面仅展示前1000条记录，查看全部请                    <span class="logdaochu"                        type="position"                        backtestId="'+backtestId+'"                    >导出每日持仓&收益</span>                </div>';$("#table-positioninfo").after(n)}else $("#tab-positioninfo").find(".ui-jqgrid-bdiv").scroll(function(){nScrollHight=$(this)[0].scrollHeight,nScrollTop=$(this)[0].scrollTop,nScrollTop+570>=nScrollHight&&addPosition(nScrollTop)}),1==t.data.status&&initPosition()}else setTimeout(fillPosition,3e3)},fail:function(t){$("#tab-positioninfo").attr("_hasDrawn",0)}})}var positionLoading=0;function addPosition(i){if(1!=positionLoading){positionLoading=1;var n=$("#table-positioninfo");Cy.ajax("/algorithm/backtest/positionInfo?backtestId="+backtestId+"&offset="+positionOffset+"&dateOffset="+positionDateOffset,{success:function(t){if(t.data.position.length<=0)1==t.data.status&&(positionLoading=0);else{for(var a=0;a<t.data.position.length;a++)n.jqGrid("addRowData",a,t.data.position[a],"last"),positionDateOffset=t.data.position[a].date;if(n.jqGrid("sortGrid","stock",!0),bindGroupEvent(n),i&&$("#tab-positioninfo").find(".ui-jqgrid-bdiv").scrollTop(i),t.data.max){var e='<div class="backtest-detail__bottom-export">                    页面仅展示前1000条记录，查看全部请                    <span class="logdaochu"                        type="position"                        backtestId="'+backtestId+'"                    >导出每日持仓&收益</span>                </div>';$("#table-positioninfo").after(e)}else positionOffset+=t.data.position.length,positionLoading=0}}})}}var riskLength=0,riskQueryCount=0;function fillRisk(){Cy.ajax("/algorithm/backtest/risk?backtestId="+backtestId,{success:function(t){if(t.data){$(".risk-loading").remove();var a=t.data.risk;0!=a||0!=riskLength?(riskLength+=a.algorithmPeriodReturn.length,drawAlgorithmPeriodReturn(a.algorithmPeriodReturn),drawBenchmarkPeriodReturn(a.benchmarkPeriodReturn),drawAlpha(a.alpha),drawBeta(a.beta),drawSharp(a.sharp),drawSortino(a.sortino),drawInformation(a.information),drawAlgovolatility(a.algovolatility),drawBenchmarkvolatility(a.benchmarkvolatility),drawMaxdrawdown(a.maxdrawdown),$(".risk-tab").attr("_hasDrawn",1)):++riskQueryCount<=5&&setTimeout(fillRisk,2200)}else setTimeout(fillRisk,2200)}})}function bindGroupEvent(t){t.find(".jqheader").click(function(){var t=this.id;return $(this.parentNode.parentNode).jqGrid("groupingToggle",t),!1}),t.find(".ui-icon-circlesmall-plus").click(function(){$(this.parentNode.parentNode).trigger("click")});var a=t.attr("id");$(".expand-all-link[tableId="+a+"]").click(function(){var t=$(this).attr("tableId");$("#"+t+" .ui-icon-circlesmall-plus").each(function(){$(this).trigger("click")})}),$(".collapse-all-link[tableId="+a+"]").click(function(){var t=$(this).attr("tableId");$("#"+t+" .ui-icon-circlesmall-minus").each(function(){$(this).trigger("click")})})}function isTanChuang(){Cy.ajax("/algorithm/backtest/nullBacktestLive",{success:function(t){"00000"===t.code&&$(".tanceng").removeClass("hidden")}})}function enableLiveTrade(){0<$("#new-algorithm").attr("_remainCount")&&($("#new-algorithm").removeClass("disabled"),$("#new-algorithm").attr("data-target","#myModal"))}function enableShare(){0==accessControl&&$("#share-backtest-button").removeClass("disabled")}initChart(function(){timeoutSpan=2e3,cycleCheck()}),$(".x-new").click(function(){$(".tanceng").addClass("hidden")});var getToday=function(){var t=new Date,a=t.getMonth()+1,e=t.getDate();return a<=9&&(a="0"+a),e<=9&&(e="0"+e),t.getFullYear()+"-"+a+"-"+e};function getByteLen(t){for(var a=0,e=0;e<t.length;e++){null!=t.charAt(e).match(/[^\x00-\xff]/gi)?a+=15:a+=7}return a}function Left(){var t=getByteLen($("#title-box").text());$("#title-box").width()>=t?$(".icon-edit").css({left:t+14}):$(".icon-edit").css({left:"calc(100% - 248px)"})}$("body").delegate(".modify-backtest-name","keyup",function(){var t=$(this),a=t.val();if(!/[A-Za-z0-9\u4e00-\u9fa5\()@_-]+$/.test(a))return a=a.replace(/[^a-zA-Z0-9\u4e00-\u9fa5\()@_]+$/,""),t.val(a),!1}),$(".icon_edit").click(function(t){var a=$(this.parentNode).find("#title-box").eq(0).text(),o=$(this).attr("_backtestId"),r=this;return BootstrapDialog.show({title:"修改回测名称",message:'名称： <input id="name" type="text" class="form-control modify-backtest-name" value="'+a+'" style="width:80%;margin-bottom:10px"><br/></div>',buttons:[{label:"提交",action:function(a){var t=a.getModalBody().find("#name"),e=t.val(),i=$("#title-box").text(),n=e||i;if((e=e.replace(/\s/g,""))&&!/^\S{1,100}$/.test(e))BootstrapDialog.show({title:"提示",message:"名称过长，请重新输入。",onhidden:function(){t.val(i)}});else{if(!e)return BootstrapDialog.show({title:"提示",message:"名称不能为空",onhidden:function(){t.val(i)}}),!1;Cy.ajax("/algorithm/backtest/setName",{data:"backtestId="+o+"&name="+n,success:function(t){return $(r.parentNode).find("#title-box").eq(0).text(n),a.close(),!1},fail:function(t){a.close(),BootstrapDialog.show({title:"提示",btnOKLabel:"确认",message:t.msg})}})}}},{label:"取消",action:function(t){t.close()}}],onshown:function(t){$("#name").blur(function(){var t=$(this),a=t.val();a&&t.val(a.replace(/[`~!#$^&*()=|{}':;',.<>/?~！%#￥……&*（）——|{}【】‘；：”“'。，、？\[\]]/g,""))})}}),t.stopPropagation(),!1}),$("body").hasClass("mobile")&&Left();var evt="onorientationchange"in window?"orientationchange":"resize";function mobile(){var t=$(".dailybars-output").height();$(".after").height(t),$("#backtest-menu-more").click(function(){t=$(".dailybars-output").height(),$(".after").height(t),"block"==$("#result-area").css("display")?$("#result-area").css({display:"none"}):$("#result-area").css({display:"block"})}),$("#result-tabs").click(function(){$(this).parent().css({display:"none"})}).next(".after").click(function(){$(this).parent().css({display:"none"})});var a=$(window).width();$(".dailybars-output").width(a).css({overflow:"auto"})}window.addEventListener(evt,function(){Left()},!1),$("body").hasClass("mobile")&&mobile(),$(".title_item").click(function(){$(".title_item").removeClass("actives"),$(this).addClass("actives"),fillTransaction()}),$("#btn-attributionAnaly").click(function(){var a=$(this).attr("backtestId"),e=window.open(),i=$(this).attr("accessKey");return Cy.ajax("/algorithm/backtest/submitAttribution?backtestId="+a,{success:function(t){e.location.href=i?"/algorithm/backtest/attributionAnaly?backtestId="+a+"&accessKey="+i:"/algorithm/backtest/attributionAnaly?backtestId="+a}}),!1});var algorithmDetail={initBaseData:function(){this.$fullBacktestBenchmark=$(".full_backtest_benchmark"),this.backtestId=$("#backtestTpl").data("backtestid")},fetchBenchmark:function(){var e=this;Cy.ajax("/algorithm/backtest/benchmarkName",{type:"get",data:{backtestId:this.backtestId},success:function(t){if("0"==t.status&&t.data&&t.data.benchmark){var a=t.data.benchmark;e.$fullBacktestBenchmark.data("benchmark",!0).attr("title",a).text(a)}}})},tryUpdateBenchmark:function(){this.$fullBacktestBenchmark.data("benchmark")||(this.fetchBenchmark(),setTimeout(this.tryUpdateBenchmark.bind(this),3e3))},init:function(){this.initBaseData(),this.tryUpdateBenchmark()}};$(document).ready(function(){$("#clickDrapdown").hover(function(){g_isMobile||($(this).addClass("checked"),$(this).find(".open_span").addClass("open"),$(".clickDrapdown").removeClass("hidden"))},function(){g_isMobile||"true"==$(this).attr("clicked")||($(this).removeClass("checked"),$(this).find(".open_span").removeClass("open"),$(".clickDrapdown").addClass("hidden"))}),$("#clickDrapdown").click(function(){if(!g_isMobile)if("true"==$(this).attr("clicked"))$(this).attr("clicked","false");else if("false"==$(this).attr("clicked"))return void $(this).attr("clicked","true");$(this).toggleClass("checked"),$(this).find(".open_span").toggleClass("open"),$(".clickDrapdown").toggleClass("hidden")}),algorithmDetail.init()});var g_isBackToTop=!1;function handleAddExportZipSuccess(t){dataZipStatusInterval=setInterval(function(){getExportStatus(t,getExportStatusUrl)},exportFrequency)}$("body").delegate(".logdaochu","click",function(){var t=$(this).attr("backtestId"),a=$(this).attr("type");$(this).text();handleAddExportZip(t,a,handleAddExportZipSuccess)});var addExportZipUrl="/algorithm/backtest/addExportZip",getExportStatusUrl="/algorithm/backtest/getExportStatus",getExportZipUrl="/algorithm/backtest/getExportZip",dataZipStatusInterval,exportFrequency=2e3,handleAddExportZip=function(t,a,e){Cy.ajax(addExportZipUrl,{data:{backtestId:t,type:a,useCredit:0},creditsModal:{title:{transaction:"导出交易详情",position:"导出持仓&收益",log:"导出日志"}[a],content:$("#title-box").text()},type:"get",success:function(t){$("body").loading({loadingWidth:240,title:"",name:"downloadData",discription:"结果压缩打包中, 请稍后",direction:"column",type:"origin",originDivWidth:40,originDivHeight:40,originWidth:6,originHeight:6,smallLoading:!1,loadingMaskBg:"rgba(0,0,0,0.2)"}),successCallback(t,function(t){e&&e(t)})},fail:function(t){errorCallback(t)}})},getExportStatus=function(a){Cy.ajax(getExportStatusUrl,{data:{task:a},type:"get",success:function(t){successCallback(t,function(t){"string"==typeof t&&(t=parseInt(t),clearInterval(dataZipStatusInterval),1===t?(removeLoading("downloadData"),getExportZip(a)):2===t&&(removeLoading("downloadData"),errorCallback({msg:"当前策略没有产生日志!"})))})},fail:function(t){clearInterval(dataZipStatusInterval),errorCallback(t)}})},getExportZip=function(t){window.location.href=[getExportZipUrl,"task="+t].join("?")},successCallback=function(t,a){"00000"===t.code?a&&a(t.data):BootstrapDialog.show({title:"提示",btnOKLabel:"确认",message:"错误:"+t.msg})},errorCallback=function(t){t&&BootstrapDialog.show({title:"提示",btnOKLabel:"确认",message:"下载失败:"+t.msg})};