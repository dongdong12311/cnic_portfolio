!function(n,e,d){function l(e){var t;(t=new Date).setDate(t.getDate()+e);var a=t.getMonth()+1,i=t.getDate();return a<=9&&(a="0"+a),i<=9&&(i="0"+i),t=t.getFullYear()+"-"+a+"-"+i}function t(){var e=d("#myModal");if(e.find(".js-modal-body").html(d(".js-modal-content").html()),u){var t=d(".pyVersionTag").text(),a=d("#baseCapital").html().split("￥")[1],i=d("#frequency").attr("value"),n={backtestId:d("#backtestTpl").attr("data-backtestId")},o=Mustache.render(p,{backOptions:n});e.find("#select-backtest").html(o).parents(".new-item").addClass("hidden"),e.find("#select-algorithm").parents(".new-item").remove(),e.find(".basecapital").val(a),e.find("#select-frequency").val(i),e.find("#pyVersionSelect").val(t)}else e.find("#pyVersionSelect").parents(".new-item").remove()}function s(){var e,a={minute:"1",day:"0",tick:"2"},i=d("#myModal").find("#select-frequency").val(),n=0,o=!1;if(e=C.data.filter(function(e,t){if(e.expireTime){if(!e.role)return"2030-12-31 00:00:00"===e.expireTime?e.time="永久":e.time="限时（"+e.expireTime.split(" ")[0]+"）到期",e.frequency="",o=!0,e;"2030-12-31 00:00:00"===e.expireTime?e.time="永久":e.time=e.expireTime.split(" ")[0]+"到期",h='{{#time}}<option value="{{expireTime}}" data-backtestSpaceId="{{backtestSpaceId}}">{{time}}</option>{{/time}}'}if(e.role>=a[i]&&e.count)return n+=1,"1"===e.role?e.frequency="分钟":"0"===e.role?e.frequency="每天":e.frequency="TICK",e}),!o)if(n){var t=document.querySelector('meta[name="vipType"]').content;"tick"===i&&!t&&d("#myModal").find(".js-algorithm-tips").hasClass("hidden")?(d(".trade-list_new-trade-no-vip-tip").removeClass("hidden"),d("#myModal").find("#submit").attr("disabled",!0)):(d("#myModal").find("#submit").attr("disabled",!1),d("#myModal").find(".js-algorithm-tips").addClass("hidden"))}else d("#myModal").find(".js-algorithm-tips").removeClass("hidden"),d("#myModal").find("#submit").attr("disabled",!0);var l=Mustache.render(h,{time:e});d("#myModal").find("#select-expireTime").html(l).addClass("hidden"),d("#myModal").find("#select-expireTime").comboSelect()}function a(){var e=d("#myModal").find("#select-frequency option:selected").val(),t=d("#myModal").find("#currentTime"),a=d("#myModal").find("#startTime");if(t.val(l(0)),d(".trade-list_new-trade-no-vip-tip").addClass("hidden"),"tick"===e?(a.addClass("hidden"),t.removeClass("hidden")):(e||d("#select-frequency").val("minute"),a.removeClass("hidden"),t.addClass("hidden")),C.data)return s(),!1;Cy.ajax(g,{success:function(e){var t=e.data;C.data=t,s()},fail:function(e){console.log(e)}})}function i(){return!d(this).hasClass("disabled")&&(T(),d("#myModal").find('input[name="name"]').val()?(d("#myModal").find("#select-algorithm").val(function(){return algorithmId=d(this).find("option").eq(0).attr("value"),algorithmId}),void x(algorithmId)):(function(){if(u){var e=d("#title-box").html()+"-模拟交易";d("#myModal").find('input[name="name"]').val(e)}else Cy.ajax(y,{success:function(e){var t=e.data.liveTradeCount;t=parseInt(t)+1,d("#myModal").find('input[name="name"]').val("模拟交易-"+t)},fail:function(e){console.log(e)}})}(),void a()))}function o(){var e=d("#select-algorithm").val();x(e)}function r(){var e=d("#myModal"),t=e.find("#select-backtest option:selected"),a=t.attr("data-frequency"),i=t.attr("data-baseCapital"),n=(e.find('#select-frequency option[value="tick"]'),e.find("#startTime")),o=e.find("#currentTime");i&&d(".basecapital").val(i),a&&d("#select-frequency").val(a),o.val(l(0)),d(".trade-list_new-trade-no-vip-tip").addClass("hidden"),"tick"===a?(n.addClass("hidden"),o.removeClass("hidden")):(a||d("#select-frequency").val("minute"),n.removeClass("hidden"),o.addClass("hidden")),s()}function c(){var e=d("#myModal"),a=l(0),t=l(0),i=l(1);e.find("#startTime").val(i),e.find("#startTime").attr("noLimit")&&(t=null),e.find("#startTime").datepicker({dateFormat:"yy-mm-dd",minDate:t,changeYear:!0,changeMonth:!0,beforeShow:function(){setTimeout(function(){d("#ui-datepicker-div").css("z-index",100007)},100)},onSelect:function(e,t){if(e===a){d.cookie("noprompt")||(C.initMyModalFlag=!1,d("#myModal").modal("hide"),BootstrapDialog.show({title:"提示",cssClass:"tipBootstrap",message:'<p>开始日期选择今天，程序是从当前创建时刻开始运行，在当前时间点之前运行的函数不再运行（如创建时间为14:00，则before_trading_start不执行）。</p><p>这样可能会造成某些变量未定义或其他问题，致使程序异常终止。</p><p>建议选择次日为开始日期</p><div id="prompt"><input type="checkbox" id="checkbox"><span>不再提示</span></div>',buttons:[{label:"确定",cssClass:"sureBtn",action:function(e){d("#checkbox").prop("checked")&&d.cookie("noprompt","1",{expires:3650,path:"/"}),e.close()}}],onhidden:function(){d("#myModal").modal("show"),C.initMyModalFlag=!0}}))}}})}function m(){var a=d("#myModal"),e=function(){var e=new Date,t=e.getDate();e.setDate(t+1);var a=e.getDate(),i=e.getMonth()+1;return i<=9&&(i="0"+i),a<=9&&(a="0"+a),e.getFullYear()+"-"+i+"-"+a}();a.find("#expireTime").datepicker({dateFormat:"yy-mm-dd",minDate:e,changeYear:!0,changeMonth:!0,beforeShow:function(){setTimeout(function(){d("#ui-datepicker-div").css("z-index",100007)},100)},onSelect:function(e,t){e=e.replace(/-/g,""),(e=parseInt(e))<=parseInt(a.find("#startTime").val().replace(/-/g,""))&&BootstrapDialog.show({title:"提示",cssClass:"tipBootstrap",message:"停止时间应晚于开始时间！",buttons:[{label:"确定",cssClass:"sureBtn",action:function(e){e.close()}}]})}})}var f=d(e),u=!!d("#backtestTpl").get(0),p='{{#backOptions}}<option value="{{backtestId}}" data-baseCapital="{{baseCapital}}" data-frequency="{{frequency}}">{{name}}</option>{{/backOptions}}',h='{{#time}}<option value="{{expireTime}}">{{time}} </option>{{/time}}',y="/algorithm/live/getLiveTradeCount",v="/algorithm/index/runList",b="/algorithm/backtest/doneList",g="/algorithm/trade/NewNullTrade",M="/algorithm/live/submit",k="/algorithm/live/index?backtestId=",C={initMyModalFlag:!0},T=function(){u||Cy.ajax(v,{success:function(e){var t,a=e.data;a.unshift({name:"请选择一个策略"}),t=Mustache.render('{{#algoptions}}<option value="{{algorithmId}}">{{name}}</option>{{/algoptions}}',{algoptions:a}),d("#myModal").find("#select-algorithm").html(t),d("#myModal").find("#select-algorithm").comboSelect(),x()},fail:function(e){console.log(e)}})},x=function(e){if(!e){var t=Mustache.render(p,{backOptions:{name:"请选择一个回测"}});return d("#myModal").find("#select-backtest").html(t),void d("#myModal").find("#select-backtest").comboSelect()}Cy.ajax(b,{type:"GET",data:{algorithmId:e},success:function(e){var t=e.data,a=d("#myModal");t.map(function(e){var t=100*e.overallReturn;t=t.toFixed(2)+"%",e.name=e.name+" - "+t}),t.unshift({name:"请选择一个回测"});var i=Mustache.render(p,{backOptions:t});a.find("#select-backtest").html(i),a.find("#select-backtest").comboSelect();var n=a.find("#select-backtest option:selected"),o=n.attr("data-baseCapital"),l=n.attr("data-frequency");a.find("#select-frequency").find('option[value="tick"]');o&&a.find(".basecapital").val(o),l&&a.find("#select-frequency").val(l)},fail:function(e){console.log(e)}})};d("#myModal").Validform({btnSubmit:"#submit",datatype:{lessthan:function(e,t,a,i){return parseInt(e)<=9e8}},tiptype:function(e,t,a){var i=d(t.obj).next(".error_tips"),n=d(t.obj).attr("errormsg");(e=3===t.type?n:"")?i.removeClass("hidden"):i.addClass("hidden"),i.html(e),d(t.obj).toggleClass("error_input",3===t.type)},callback:function(e){var t={},i=d(e).find("#submit"),a=d("#myModal");i.html("编译中..."),i.attr("disabled","disabled"),"tick"===d("#myModal #select-frequency").val()&&a.find("#startTime").val(a.find("#currentTime").val()),a.find("#select-expireTime option:checked").attr("data-backtestspaceid")&&(t="&backtestSpaceId="+a.find("#select-expireTime option:checked").attr("data-backtestspaceid")),Cy.ajaxForm(d("#myModal").find("form"),M,!1,function(e){return n.location.href=k+e.data.backtestId,!1},null,t,function(e){BootstrapDialog.show({title:"提示",btnOKLabel:"确认",message:"编译失败:"+e.msg,onshow:function(){C.initMyModalFlag=!1,d("#myModal").modal("hide")},onhidden:function(){d("#myModal").modal("show"),C.initMyModalFlag=!0}}),i.html("确定"),i.attr("disabled",!1)},function(e){var t="";for(var a in e)t+="<span>"+e[a]+"</span><br/>";BootstrapDialog.show({title:"提示",btnOKLabel:"确认",message:"编译失败:"+t,onshow:function(){C.initMyModalFlag=!1,d("#myModal").modal("hide")},onhidden:function(){d("#myModal").modal("show"),C.initMyModalFlag=!0}}),i.html("确定"),i.attr("disabled",!1)})}});t(),c(),m(),f.delegate("#new-algorithm","click",i),f.delegate("#select-algorithm","change",o),f.delegate("#select-backtest","change",r),f.delegate("#myModal #select-frequency","change",a),f.delegate("#myModal","hidden.bs.modal",function(){C.initMyModalFlag&&(t(),c(),m())})}(window,document,jQuery);